"use strict";(self.webpackChunkdatacraft_school=self.webpackChunkdatacraft_school||[]).push([[9796],{8453:(e,i,n)=>{n.d(i,{R:()=>t,x:()=>s});var l=n(6540);const a={},r=l.createContext(a);function t(e){const i=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function s(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),l.createElement(r.Provider,{value:i},e.children)}},9956:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"databricks-file-compaction","title":"File Compaction & Delta File Management","description":"Learn how file compaction, small file problems, and Delta Lake file management work in Databricks. Discover how to keep your Lakehouse fast and cost-efficient using optimize techniques and best practices.","source":"@site/docs-databricks/databricks-file-compaction.md","sourceDirName":".","slug":"/databricks-file-compaction","permalink":"/databricks/databricks-file-compaction","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"databricks-file-compaction","title":"File Compaction & Delta File Management","sidebar_label":"File Compaction","description":"Learn how file compaction, small file problems, and Delta Lake file management work in Databricks. Discover how to keep your Lakehouse fast and cost-efficient using optimize techniques and best practices.","keywords":["Databricks file compaction","Delta small files","Delta Lake optimization","Databricks file management","data lake performance"]},"sidebar":"tutorialSidebar2","previous":{"title":"OPTIMIZE & Z-ORDER","permalink":"/databricks/databricks-optimize-zorder"},"next":{"title":"Caching Best Practices","permalink":"/databricks/databricks-caching-best-practices"}}');var a=n(4848),r=n(8453);const t={id:"databricks-file-compaction",title:"File Compaction & Delta File Management",sidebar_label:"File Compaction",description:"Learn how file compaction, small file problems, and Delta Lake file management work in Databricks. Discover how to keep your Lakehouse fast and cost-efficient using optimize techniques and best practices.",keywords:["Databricks file compaction","Delta small files","Delta Lake optimization","Databricks file management","data lake performance"]},s="File Compaction & Delta File Management",o={},c=[{value:"\u2728 Story Time \u2014 \u201cWhy Are My Queries Slowing Down Every Week?\u201d",id:"-story-time--why-are-my-queries-slowing-down-every-week",level:2},{value:"\ud83e\udde9 What Is File Compaction in Delta Lake?",id:"-what-is-file-compaction-in-delta-lake",level:2},{value:"\ud83d\udd0d Why Small Files Hurt Performance",id:"-why-small-files-hurt-performance",level:2},{value:"\u274c More files = More metadata",id:"-more-files--more-metadata",level:3},{value:"\u274c More files = More unnecessary reads",id:"-more-files--more-unnecessary-reads",level:3},{value:"\u274c More files = Higher storage cost",id:"-more-files--higher-storage-cost",level:3},{value:"\u274c More files = Slower Z-ORDER &amp; OPTIMIZE",id:"-more-files--slower-z-order--optimize",level:3},{value:"\u2699\ufe0f How Delta Performs File Compaction",id:"\ufe0f-how-delta-performs-file-compaction",level:2},{value:"The key command:",id:"the-key-command",level:3},{value:"\ud83d\udd01 Automatic File Compaction (With Auto-Optimize)",id:"-automatic-file-compaction-with-auto-optimize",level:2},{value:"What these do:",id:"what-these-do",level:3},{value:"\ud83e\uddea Real-World Example \u2014 Before &amp; After Compaction",id:"-real-world-example--before--after-compaction",level:2},{value:"\ud83d\udce6 Delta File Management \u2014 The Full Picture",id:"-delta-file-management--the-full-picture",level:2},{value:"\ud83c\udfaf Best Practices for File Compaction",id:"-best-practices-for-file-compaction",level:2},{value:"\u2705 1. Compact high-ingestion tables regularly",id:"-1-compact-high-ingestion-tables-regularly",level:3},{value:"\u2705 2. Enable Auto-Optimize for streaming workloads",id:"-2-enable-auto-optimize-for-streaming-workloads",level:3},{value:"\u2705 3. Combine OPTIMIZE with Z-ORDER",id:"-3-combine-optimize-with-z-order",level:3},{value:"\u2705 4. Avoid over-partitioning",id:"-4-avoid-over-partitioning",level:3},{value:"\u2705 5. Use VACUUM after compaction",id:"-5-use-vacuum-after-compaction",level:3},{value:"\u2705 6. Monitor file count",id:"-6-monitor-file-count",level:3},{value:"\ud83d\udcd8 Summary",id:"-summary",level:2}];function d(e){const i={br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.header,{children:(0,a.jsx)(i.h1,{id:"file-compaction--delta-file-management",children:"File Compaction & Delta File Management"})}),"\n",(0,a.jsx)(i.h2,{id:"-story-time--why-are-my-queries-slowing-down-every-week",children:"\u2728 Story Time \u2014 \u201cWhy Are My Queries Slowing Down Every Week?\u201d"}),"\n",(0,a.jsx)(i.p,{children:"Meet Arjun, a data engineer responsible for maintaining a busy Delta Lake table receiving:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"CDC updates every 5 minutes"}),"\n",(0,a.jsx)(i.li,{children:"Batch data every hour"}),"\n",(0,a.jsx)(i.li,{children:"Streaming inserts all day"}),"\n"]}),"\n",(0,a.jsxs)(i.p,{children:["At first, everything is fast.",(0,a.jsx)(i.br,{}),"\n","But after a few weeks:"]}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"Queries slow down"}),"\n",(0,a.jsx)(i.li,{children:"Dashboards lag"}),"\n",(0,a.jsx)(i.li,{children:"Costs increase"}),"\n",(0,a.jsxs)(i.li,{children:["Data engineers keep asking: ",(0,a.jsx)(i.em,{children:"\u201cWhy is Delta so slow now?\u201d"})]}),"\n"]}),"\n",(0,a.jsx)(i.p,{children:"Arjun opens the Delta table storage\u2026"}),"\n",(0,a.jsxs)(i.p,{children:["He sees ",(0,a.jsx)(i.strong,{children:"THOUSANDS of tiny files"})," \u2014 the dreaded ",(0,a.jsx)(i.strong,{children:"Small File Problem"}),"."]}),"\n",(0,a.jsxs)(i.p,{children:["He smiles again.",(0,a.jsx)(i.br,{}),"\n","He knows exactly what\u2019s needed:"]}),"\n",(0,a.jsxs)(i.p,{children:["\u27a1 ",(0,a.jsx)(i.strong,{children:"File Compaction & Proper Delta File Management"}),"."]}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-what-is-file-compaction-in-delta-lake",children:"\ud83e\udde9 What Is File Compaction in Delta Lake?"}),"\n",(0,a.jsxs)(i.p,{children:["File compaction is the process of ",(0,a.jsx)(i.strong,{children:"merging many small Delta files into fewer, larger, optimized files"}),"."]}),"\n",(0,a.jsx)(i.p,{children:"Why small files happen:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"Streaming writes produce small batches"}),"\n",(0,a.jsx)(i.li,{children:"Frequent micro-batch ingest"}),"\n",(0,a.jsx)(i.li,{children:"CDC jobs write small delta chunks"}),"\n",(0,a.jsx)(i.li,{children:"Over-partitioning causes tiny files per partition"}),"\n"]}),"\n",(0,a.jsxs)(i.p,{children:["Small files = ",(0,a.jsx)(i.strong,{children:"slow queries + high compute cost + too much metadata"}),"."]}),"\n",(0,a.jsx)(i.p,{children:"Compaction solves this by:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"Reducing file count"}),"\n",(0,a.jsx)(i.li,{children:"Increasing file size"}),"\n",(0,a.jsx)(i.li,{children:"Improving read performance"}),"\n",(0,a.jsx)(i.li,{children:"Reducing metadata overhead"}),"\n"]}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-why-small-files-hurt-performance",children:"\ud83d\udd0d Why Small Files Hurt Performance"}),"\n",(0,a.jsx)(i.h3,{id:"-more-files--more-metadata",children:"\u274c More files = More metadata"}),"\n",(0,a.jsx)(i.p,{children:"Each query has to read metadata for every file \u2192 slower planning."}),"\n",(0,a.jsx)(i.h3,{id:"-more-files--more-unnecessary-reads",children:"\u274c More files = More unnecessary reads"}),"\n",(0,a.jsx)(i.p,{children:"Even if only 1 row matches the filter, Databricks still must scan many files."}),"\n",(0,a.jsx)(i.h3,{id:"-more-files--higher-storage-cost",children:"\u274c More files = Higher storage cost"}),"\n",(0,a.jsx)(i.p,{children:"Many tiny files create version bloat."}),"\n",(0,a.jsx)(i.h3,{id:"-more-files--slower-z-order--optimize",children:"\u274c More files = Slower Z-ORDER & OPTIMIZE"}),"\n",(0,a.jsx)(i.p,{children:"The more files you have, the heavier maintenance operations become."}),"\n",(0,a.jsx)(i.p,{children:(0,a.jsx)(i.strong,{children:"Solution \u2192 Compaction through OPTIMIZE."})}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"\ufe0f-how-delta-performs-file-compaction",children:"\u2699\ufe0f How Delta Performs File Compaction"}),"\n",(0,a.jsx)(i.h3,{id:"the-key-command",children:"The key command:"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-sql",children:"OPTIMIZE my_delta_table;\n"})}),"\n",(0,a.jsx)(i.p,{children:"What it does:"}),"\n",(0,a.jsxs)(i.ol,{children:["\n",(0,a.jsx)(i.li,{children:"Scans small files"}),"\n",(0,a.jsx)(i.li,{children:"Groups and merges them"}),"\n",(0,a.jsx)(i.li,{children:"Writes larger Parquet files (typically 128\u2013512MB)"}),"\n",(0,a.jsx)(i.li,{children:"Updates Delta transaction log"}),"\n",(0,a.jsx)(i.li,{children:"Removes old small files (via VACUUM)"}),"\n"]}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-automatic-file-compaction-with-auto-optimize",children:"\ud83d\udd01 Automatic File Compaction (With Auto-Optimize)"}),"\n",(0,a.jsx)(i.p,{children:"Databricks also offers automated compaction:"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-sql",children:"ALTER TABLE my_delta_table\r\nSET TBLPROPERTIES (\r\n  'delta.autoOptimize.optimizeWrite' = 'true',\r\n  'delta.autoOptimize.autoCompact' = 'true'\r\n);\n"})}),"\n",(0,a.jsx)(i.h3,{id:"what-these-do",children:"What these do:"}),"\n",(0,a.jsxs)(i.table,{children:[(0,a.jsx)(i.thead,{children:(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.th,{children:"Property"}),(0,a.jsx)(i.th,{children:"Action"})]})}),(0,a.jsxs)(i.tbody,{children:[(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:(0,a.jsx)(i.code,{children:"optimizeWrite"})}),(0,a.jsx)(i.td,{children:"Writes fewer, larger files during ingest"})]}),(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:(0,a.jsx)(i.code,{children:"autoCompact"})}),(0,a.jsx)(i.td,{children:"Merges files after small batch inserts"})]})]})]}),"\n",(0,a.jsx)(i.p,{children:"Perfect for streaming or frequent batches."}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-real-world-example--before--after-compaction",children:"\ud83e\uddea Real-World Example \u2014 Before & After Compaction"}),"\n",(0,a.jsx)(i.p,{children:"Arjun\u2019s table (before):"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"8,200 files per partition"}),"\n",(0,a.jsx)(i.li,{children:"Avg file size: 40KB"}),"\n",(0,a.jsxs)(i.li,{children:["Query runtime: ",(0,a.jsx)(i.strong,{children:"34 seconds"})]}),"\n"]}),"\n",(0,a.jsx)(i.p,{children:"After:"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-sql",children:"OPTIMIZE sales_data ZORDER BY (customer_id);\r\nVACUUM sales_data RETAIN 168 HOURS;\n"})}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"320 files per partition"}),"\n",(0,a.jsx)(i.li,{children:"Avg file size: 300MB"}),"\n",(0,a.jsxs)(i.li,{children:["Query runtime: ",(0,a.jsx)(i.strong,{children:"5 seconds"})]}),"\n"]}),"\n",(0,a.jsx)(i.p,{children:"Improved performance, reduced cost, and less pressure on the cluster."}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-delta-file-management--the-full-picture",children:"\ud83d\udce6 Delta File Management \u2014 The Full Picture"}),"\n",(0,a.jsx)(i.p,{children:"Delta Lake automatically manages:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["Transaction logs (",(0,a.jsx)(i.code,{children:"_delta_log/"}),")"]}),"\n",(0,a.jsx)(i.li,{children:"Versioning"}),"\n",(0,a.jsx)(i.li,{children:"Compaction"}),"\n",(0,a.jsx)(i.li,{children:"Data skipping"}),"\n",(0,a.jsx)(i.li,{children:"File pruning"}),"\n",(0,a.jsx)(i.li,{children:"Data removal with VACUUM"}),"\n"]}),"\n",(0,a.jsxs)(i.p,{children:["But ",(0,a.jsx)(i.strong,{children:"you"})," must manage:"]}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"When to compact"}),"\n",(0,a.jsx)(i.li,{children:"How often to vacuum"}),"\n",(0,a.jsx)(i.li,{children:"How to structure partitions"}),"\n",(0,a.jsx)(i.li,{children:"How to avoid unnecessary file explosion"}),"\n"]}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-best-practices-for-file-compaction",children:"\ud83c\udfaf Best Practices for File Compaction"}),"\n",(0,a.jsx)(i.h3,{id:"-1-compact-high-ingestion-tables-regularly",children:"\u2705 1. Compact high-ingestion tables regularly"}),"\n",(0,a.jsx)(i.p,{children:"Daily or weekly, depending on volume."}),"\n",(0,a.jsx)(i.h3,{id:"-2-enable-auto-optimize-for-streaming-workloads",children:"\u2705 2. Enable Auto-Optimize for streaming workloads"}),"\n",(0,a.jsx)(i.p,{children:"Reduces small files during writes."}),"\n",(0,a.jsx)(i.h3,{id:"-3-combine-optimize-with-z-order",children:"\u2705 3. Combine OPTIMIZE with Z-ORDER"}),"\n",(0,a.jsx)(i.p,{children:"Boosts data skipping for faster queries."}),"\n",(0,a.jsx)(i.h3,{id:"-4-avoid-over-partitioning",children:"\u2705 4. Avoid over-partitioning"}),"\n",(0,a.jsx)(i.p,{children:"Too many partitions \u2192 too many tiny files."}),"\n",(0,a.jsx)(i.h3,{id:"-5-use-vacuum-after-compaction",children:"\u2705 5. Use VACUUM after compaction"}),"\n",(0,a.jsx)(i.p,{children:"Clean old files and free storage:"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-sql",children:"VACUUM my_delta_table RETAIN 168 HOURS;\n"})}),"\n",(0,a.jsx)(i.h3,{id:"-6-monitor-file-count",children:"\u2705 6. Monitor file count"}),"\n",(0,a.jsx)(i.p,{children:"If files per partition > 1000 \u2192 compaction required."}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h2,{id:"-summary",children:"\ud83d\udcd8 Summary"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"File compaction merges small files into large, efficient ones."}),"\n",(0,a.jsx)(i.li,{children:"Small files slow down queries, inflate compute cost, and destroy performance."}),"\n",(0,a.jsx)(i.li,{children:"OPTIMIZE + Auto-Optimize are the main tools for managing Delta Lake storage."}),"\n",(0,a.jsx)(i.li,{children:"Use VACUUM to clear old files after compaction."}),"\n",(0,a.jsxs)(i.li,{children:["Proper file management makes your Lakehouse ",(0,a.jsx)(i.strong,{children:"fast, clean, and cost-efficient"}),"."]}),"\n"]}),"\n",(0,a.jsx)(i.hr,{}),"\n",(0,a.jsx)(i.h1,{id:"-next-topic",children:"\ud83d\udc49 Next Topic"}),"\n",(0,a.jsx)(i.p,{children:(0,a.jsx)(i.strong,{children:"Caching in Databricks \u2014 Best Practices"})})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,a.jsx)(i,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);