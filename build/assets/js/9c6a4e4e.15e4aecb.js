"use strict";(self.webpackChunkdatacraft_school=self.webpackChunkdatacraft_school||[]).push([[240],{5655:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"snowflake-automatic-query-optimization","title":"Automatic Query Optimization \u2014 How Snowflake Internally Works","description":"A story-driven deep dive into how Snowflake automatically optimizes SQL queries behind the scenes, including pruning, micro-partitions, statistics, dynamic filtering, and adaptive execution.","source":"@site/docs-snowflake/snowflake-automatic-query-optimization.md","sourceDirName":".","slug":"/snowflake-automatic-query-optimization","permalink":"/snowflake/snowflake-automatic-query-optimization","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"snowflake-automatic-query-optimization","title":"Automatic Query Optimization \u2014 How Snowflake Internally Works","sidebar_label":"Automatic Query Optimization","description":"A story-driven deep dive into how Snowflake automatically optimizes SQL queries behind the scenes, including pruning, micro-partitions, statistics, dynamic filtering, and adaptive execution.","keywords":["Snowflake query optimization","Snowflake automatic optimization","Snowflake pruning","query tuning in Snowflake","micro-partitions","Snowflake performance"]},"sidebar":"tutorialSidebar1","previous":{"title":"Warehouse Sizing","permalink":"/snowflake/snowflake-warehouse-sizing"},"next":{"title":"Query Profile Explained","permalink":"/snowflake/snowflake-query-profile"}}');var s=i(4848),l=i(8453);const r={id:"snowflake-automatic-query-optimization",title:"Automatic Query Optimization \u2014 How Snowflake Internally Works",sidebar_label:"Automatic Query Optimization",description:"A story-driven deep dive into how Snowflake automatically optimizes SQL queries behind the scenes, including pruning, micro-partitions, statistics, dynamic filtering, and adaptive execution.",keywords:["Snowflake query optimization","Snowflake automatic optimization","Snowflake pruning","query tuning in Snowflake","micro-partitions","Snowflake performance"]},a="Automatic Query Optimization \u2014 How Snowflake Internally Works",o={},c=[{value:"\u2728 Story Time \u2014 \u201cHow Is Snowflake So Fast Without Tuning?\u201d",id:"-story-time--how-is-snowflake-so-fast-without-tuning",level:2},{value:"\ud83e\udde9 The Secret: \u201cSelf-Optimizing Cloud Database\u201d",id:"-the-secret-self-optimizing-cloud-database",level:2},{value:"\ud83e\uddf1 1. Micro-Partitions: Snowflake\u2019s Magic Building Blocks",id:"-1-micro-partitions-snowflakes-magic-building-blocks",level:2},{value:"Example:",id:"example",level:3},{value:"\u2702\ufe0f 2. Automatic Partition Pruning",id:"\ufe0f-2-automatic-partition-pruning",level:2},{value:"Query:",id:"query",level:3},{value:"\ud83c\udfaf 3. Dynamic Filtering (Run-Time Optimization)",id:"-3-dynamic-filtering-run-time-optimization",level:2},{value:"\ud83e\udde0 4. Automatic Statistics Collection",id:"-4-automatic-statistics-collection",level:2},{value:"\ud83d\udd00 5. Smart Join Optimization",id:"-5-smart-join-optimization",level:2},{value:"\u26a1 6. Automatic Caching Layers",id:"-6-automatic-caching-layers",level:2},{value:"\u2714 Result Cache",id:"-result-cache",level:3},{value:"\u2714 Metadata Cache",id:"-metadata-cache",level:3},{value:"\u2714 Data Cache",id:"-data-cache",level:3},{value:"\ud83d\udd04 7. Adaptive Execution (Rerouting On the Fly)",id:"-7-adaptive-execution-rerouting-on-the-fly",level:2},{value:"\ud83d\ude80 8. Query Rewriting &amp; Pushdown Optimization",id:"-8-query-rewriting--pushdown-optimization",level:2},{value:"\u2714 Filter Pushdown",id:"-filter-pushdown",level:3},{value:"\u2714 Projection Pushdown",id:"-projection-pushdown",level:3},{value:"\u2714 Join Reordering",id:"-join-reordering",level:3},{value:"\u2714 Subquery Flattening",id:"-subquery-flattening",level:3},{value:"\u2714 Expression Simplification",id:"-expression-simplification",level:3},{value:"\ud83e\uddea Real-World Story \u2014 Priya Tests a Query",id:"-real-world-story--priya-tests-a-query",level:2},{value:"\ud83e\uddd8 Snowflake Removes Complexity So You Focus on SQL",id:"-snowflake-removes-complexity-so-you-focus-on-sql",level:2},{value:"You <strong>don\u2019t</strong> need to:",id:"you-dont-need-to",level:3},{value:"Snowflake <strong>does</strong>:",id:"snowflake-does",level:3},{value:"\ud83d\udcd8 Summary",id:"-summary",level:2}];function d(e){const n={blockquote:"blockquote",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"automatic-query-optimization--how-snowflake-internally-works",children:"Automatic Query Optimization \u2014 How Snowflake Internally Works"})}),"\n",(0,s.jsx)(n.h2,{id:"-story-time--how-is-snowflake-so-fast-without-tuning",children:"\u2728 Story Time \u2014 \u201cHow Is Snowflake So Fast Without Tuning?\u201d"}),"\n",(0,s.jsxs)(n.p,{children:["Priya, a senior data engineer, just joined a team coming from an on-premise SQL world.",(0,s.jsx)(n.br,{}),"\n","She\u2019s used to:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"manual indexing"}),"\n",(0,s.jsx)(n.li,{children:"statistics updates"}),"\n",(0,s.jsx)(n.li,{children:"partition keys"}),"\n",(0,s.jsx)(n.li,{children:"vacuuming"}),"\n",(0,s.jsx)(n.li,{children:"query hints"}),"\n",(0,s.jsx)(n.li,{children:"and lots of performance babysitting"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"When she opens Snowflake, she\u2019s confused:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u201cWhere do I create indexes?\u201d",(0,s.jsx)(n.br,{}),"\n","\u201cShould I vacuum the table?\u201d",(0,s.jsx)(n.br,{}),"\n","\u201cWhen do I update stats?\u201d",(0,s.jsx)(n.br,{}),"\n","\u201cHow do I optimize the query planner?\u201d"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Her colleague smiles and says:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u201cYou don\u2019t. Snowflake does all of it automatically.\u201d"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Now Priya is curious:",(0,s.jsx)(n.br,{}),"\n",(0,s.jsxs)(n.strong,{children:["What exactly is Snowflake doing behind the scenes?",(0,s.jsx)(n.br,{}),"\n","And how does it make queries fast without manual tuning?"]})]}),"\n",(0,s.jsx)(n.p,{children:"Let\u2019s break it down."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-the-secret-self-optimizing-cloud-database",children:"\ud83e\udde9 The Secret: \u201cSelf-Optimizing Cloud Database\u201d"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake automatically optimizes:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"data storage"}),"\n",(0,s.jsx)(n.li,{children:"metadata"}),"\n",(0,s.jsx)(n.li,{children:"query planning"}),"\n",(0,s.jsx)(n.li,{children:"pruning"}),"\n",(0,s.jsx)(n.li,{children:"statistics"}),"\n",(0,s.jsx)(n.li,{children:"joins"}),"\n",(0,s.jsx)(n.li,{children:"execution paths"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["You don\u2019t manage indexes or partitions because Snowflake uses ",(0,s.jsx)(n.strong,{children:"micro-partitions"})," and ",(0,s.jsx)(n.strong,{children:"automated metadata"})," to optimize everything."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-1-micro-partitions-snowflakes-magic-building-blocks",children:"\ud83e\uddf1 1. Micro-Partitions: Snowflake\u2019s Magic Building Blocks"}),"\n",(0,s.jsxs)(n.p,{children:["Snowflake stores data in ",(0,s.jsx)(n.strong,{children:"immutable micro-partitions"})," (50\u2013500MB each)."]}),"\n",(0,s.jsx)(n.p,{children:"Each partition stores:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"min/max values for each column"}),"\n",(0,s.jsx)(n.li,{children:"null counts"}),"\n",(0,s.jsx)(n.li,{children:"distinct values"}),"\n",(0,s.jsx)(n.li,{children:"bloom filters"}),"\n",(0,s.jsx)(n.li,{children:"zone maps"}),"\n",(0,s.jsx)(n.li,{children:"other statistics"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["These statistics allow Snowflake to ",(0,s.jsx)(n.strong,{children:"skip entire chunks of data"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"example",children:"Example:"}),"\n",(0,s.jsxs)(n.p,{children:["If your table has 500 micro-partitions",(0,s.jsx)(n.br,{}),"\n","but your query only matches 5 of them\u2026"]}),"\n",(0,s.jsxs)(n.p,{children:["Snowflake reads ",(0,s.jsx)(n.strong,{children:"5"}),", not 500.",(0,s.jsx)(n.br,{}),"\n","That\u2019s the secret of its speed."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-2-automatic-partition-pruning",children:"\u2702\ufe0f 2. Automatic Partition Pruning"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake reads metadata \u2192 identifies which partitions contain relevant data \u2192 skips the rest."}),"\n",(0,s.jsx)(n.h3,{id:"query",children:"Query:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *\r\nFROM SALES\r\nWHERE SALE_DATE = '2025-01-01';\n"})}),"\n",(0,s.jsx)(n.p,{children:"Snowflake does:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Find micro-partitions whose SALE_DATE range includes this date"}),"\n",(0,s.jsx)(n.li,{children:"Scan only those"}),"\n",(0,s.jsx)(n.li,{children:"Skip the rest"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"No manual partitioning needed."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-3-dynamic-filtering-run-time-optimization",children:"\ud83c\udfaf 3. Dynamic Filtering (Run-Time Optimization)"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake adjusts execution while the query is running."}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *\r\nFROM ORDERS o\r\nJOIN CUSTOMERS c\r\n  ON o.customer_id = c.id\r\nWHERE c.country = 'Canada';\n"})}),"\n",(0,s.jsx)(n.p,{children:"Snowflake:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Filters CUSTOMERS to Canada"}),"\n",(0,s.jsx)(n.li,{children:"Dynamically reduces join input"}),"\n",(0,s.jsx)(n.li,{children:"Pushes filter down into ORDERS join"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This reduces compute dramatically."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-4-automatic-statistics-collection",children:"\ud83e\udde0 4. Automatic Statistics Collection"}),"\n",(0,s.jsx)(n.p,{children:"In older databases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"you manually collect stats"}),"\n",(0,s.jsx)(n.li,{children:"stats become stale"}),"\n",(0,s.jsx)(n.li,{children:"performance drops"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In Snowflake:"}),"\n",(0,s.jsx)(n.p,{children:"\u2714 Stats are auto-updated\r\n\u2714 Metadata is always fresh\r\n\u2714 No ANALYZE TABLE needed\r\n\u2714 No indexes to maintain"}),"\n",(0,s.jsx)(n.p,{children:"This enables accurate and efficient query plans."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-5-smart-join-optimization",children:"\ud83d\udd00 5. Smart Join Optimization"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake chooses:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Broadcast join"}),"\n",(0,s.jsx)(n.li,{children:"Hash join"}),"\n",(0,s.jsx)(n.li,{children:"Merge join"}),"\n",(0,s.jsx)(n.li,{children:"Partitioned join"}),"\n",(0,s.jsx)(n.li,{children:"Local join"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Based on:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"table size"}),"\n",(0,s.jsx)(n.li,{children:"micro-partition statistics"}),"\n",(0,s.jsx)(n.li,{children:"compute warehouse size"}),"\n",(0,s.jsx)(n.li,{children:"filter selectivity"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Example:\r\nIf one table is small, Snowflake automatically chooses ",(0,s.jsx)(n.strong,{children:"broadcast join"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Even better:\r\nIt may broadcast a ",(0,s.jsx)(n.em,{children:"portion"})," of a table if only part of it is required."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-6-automatic-caching-layers",children:"\u26a1 6. Automatic Caching Layers"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake uses:"}),"\n",(0,s.jsx)(n.h3,{id:"-result-cache",children:"\u2714 Result Cache"}),"\n",(0,s.jsx)(n.p,{children:"If query is identical \u2192 returns results instantly."}),"\n",(0,s.jsx)(n.h3,{id:"-metadata-cache",children:"\u2714 Metadata Cache"}),"\n",(0,s.jsx)(n.p,{children:"Accelerates planning."}),"\n",(0,s.jsx)(n.h3,{id:"-data-cache",children:"\u2714 Data Cache"}),"\n",(0,s.jsx)(n.p,{children:"Warehouse-level storage for frequently accessed micro-partitions."}),"\n",(0,s.jsx)(n.p,{children:"You don\u2019t manage cache settings \u2014 Snowflake decides automatically."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-7-adaptive-execution-rerouting-on-the-fly",children:"\ud83d\udd04 7. Adaptive Execution (Rerouting On the Fly)"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake detects:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"skewed partitions"}),"\n",(0,s.jsx)(n.li,{children:"slow nodes"}),"\n",(0,s.jsx)(n.li,{children:"uneven workload distribution"}),"\n",(0,s.jsx)(n.li,{children:"large intermediate results"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Then dynamically adjusts:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"repartitioning strategy"}),"\n",(0,s.jsx)(n.li,{children:"join ordering"}),"\n",(0,s.jsx)(n.li,{children:"operator scheduling"}),"\n",(0,s.jsx)(n.li,{children:"parallelism"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Think of it as ",(0,s.jsx)(n.strong,{children:"self-healing"})," performance."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-8-query-rewriting--pushdown-optimization",children:"\ud83d\ude80 8. Query Rewriting & Pushdown Optimization"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake automatically rewrites queries when possible:"}),"\n",(0,s.jsx)(n.h3,{id:"-filter-pushdown",children:"\u2714 Filter Pushdown"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake pushes WHERE conditions deeper into operations."}),"\n",(0,s.jsx)(n.h3,{id:"-projection-pushdown",children:"\u2714 Projection Pushdown"}),"\n",(0,s.jsx)(n.p,{children:"Only SELECTed columns are processed."}),"\n",(0,s.jsx)(n.h3,{id:"-join-reordering",children:"\u2714 Join Reordering"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake reorders joins to reduce cost."}),"\n",(0,s.jsx)(n.h3,{id:"-subquery-flattening",children:"\u2714 Subquery Flattening"}),"\n",(0,s.jsx)(n.p,{children:"Nested queries \u2192 simplified execution plan."}),"\n",(0,s.jsx)(n.h3,{id:"-expression-simplification",children:"\u2714 Expression Simplification"}),"\n",(0,s.jsx)(n.p,{children:"Removes unnecessary expressions."}),"\n",(0,s.jsx)(n.p,{children:"You write simple SQL \u2014 Snowflake writes an optimized version internally."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-real-world-story--priya-tests-a-query",children:"\ud83e\uddea Real-World Story \u2014 Priya Tests a Query"}),"\n",(0,s.jsx)(n.p,{children:"Priya runs a heavy join on a Small warehouse."}),"\n",(0,s.jsx)(n.p,{children:"Her assumptions:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Large warehouse = faster"}),"\n",(0,s.jsx)(n.li,{children:"Snowflake may not optimize the join"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Reality:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Snowflake pruned 80% of partitions"}),"\n",(0,s.jsx)(n.li,{children:"Broadcasted the smaller table"}),"\n",(0,s.jsx)(n.li,{children:"Pushed filters into the join"}),"\n",(0,s.jsx)(n.li,{children:"Parallelized execution"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Query completed in ",(0,s.jsx)(n.strong,{children:"6 seconds"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"When she doubled the warehouse size, the runtime improved only slightly."}),"\n",(0,s.jsx)(n.p,{children:"She smiles:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u201cOkay\u2026 now I understand why Snowflake needs no manual indexing.\u201d"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-snowflake-removes-complexity-so-you-focus-on-sql",children:"\ud83e\uddd8 Snowflake Removes Complexity So You Focus on SQL"}),"\n",(0,s.jsxs)(n.h3,{id:"you-dont-need-to",children:["You ",(0,s.jsx)(n.strong,{children:"don\u2019t"})," need to:"]}),"\n",(0,s.jsx)(n.p,{children:"\u274c create indexes\r\n\u274c maintain partitions\r\n\u274c vacuum tables\r\n\u274c update statistics\r\n\u274c tune manual query hints"}),"\n",(0,s.jsxs)(n.h3,{id:"snowflake-does",children:["Snowflake ",(0,s.jsx)(n.strong,{children:"does"}),":"]}),"\n",(0,s.jsx)(n.p,{children:"\u2714 pruning\r\n\u2714 caching\r\n\u2714 statistics\r\n\u2714 query rewriting\r\n\u2714 join optimization\r\n\u2714 dynamic filtering\r\n\u2714 adaptive execution"}),"\n",(0,s.jsx)(n.p,{children:"Automatically.\r\nContinuously.\r\nBehind the scenes."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-summary",children:"\ud83d\udcd8 Summary"}),"\n",(0,s.jsx)(n.p,{children:"Snowflake\u2019s Automatic Query Optimization includes:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Smart metadata & micro-partitions"}),"\n",(0,s.jsx)(n.li,{children:"Partition pruning"}),"\n",(0,s.jsx)(n.li,{children:"Dynamic runtime filtering"}),"\n",(0,s.jsx)(n.li,{children:"Automated statistics updates"}),"\n",(0,s.jsx)(n.li,{children:"Adaptive query execution"}),"\n",(0,s.jsx)(n.li,{children:"Intelligent join selection"}),"\n",(0,s.jsx)(n.li,{children:"Transparent caching"}),"\n",(0,s.jsx)(n.li,{children:"Internal query rewriting"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This is why Snowflake feels \u201cfast without effort\u201d \u2014 the optimizer is always working in the background so you can focus on building data pipelines and writing clean SQL."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"-next-topic",children:"\ud83d\udc49 Next Topic"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Query Profile \u2014 Full Explanation of Each Section"})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var t=i(6540);const s={},l=t.createContext(s);function r(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);