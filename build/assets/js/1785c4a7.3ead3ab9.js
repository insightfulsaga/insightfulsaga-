"use strict";(self.webpackChunkdatacraft_school=self.webpackChunkdatacraft_school||[]).push([[7307],{140:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"improving-lakehouse-performance","title":"Improving Lakehouse Performance \u2014 Dos & Don\u2019ts","description":"Learn the essential performance optimization techniques for the Databricks Lakehouse. A story-driven, SEO-friendly guide covering file management, Z-ORDER, caching, Photon, SQL tuning, and architecture best practices.","source":"@site/docs-databricks/improving-lakehouse-performance.md","sourceDirName":".","slug":"/improving-lakehouse-performance","permalink":"/databricks/improving-lakehouse-performance","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"improving-lakehouse-performance","title":"Improving Lakehouse Performance \u2014 Dos & Don\u2019ts","sidebar_label":"Lakehouse Performance","description":"Learn the essential performance optimization techniques for the Databricks Lakehouse. A story-driven, SEO-friendly guide covering file management, Z-ORDER, caching, Photon, SQL tuning, and architecture best practices.","keywords":["Databricks performance tuning","Lakehouse performance best practices","Delta Lake optimization","Databricks tuning guide","data engineering performance"]},"sidebar":"tutorialSidebar2","previous":{"title":"SQL Endpoint Tuning","permalink":"/databricks/databricks-sql-endpoint-tuning"},"next":{"title":"Unity Catalog","permalink":"/databricks/unity-catalog-central-governance"}}');var s=i(4848),l=i(8453);const t={id:"improving-lakehouse-performance",title:"Improving Lakehouse Performance \u2014 Dos & Don\u2019ts",sidebar_label:"Lakehouse Performance",description:"Learn the essential performance optimization techniques for the Databricks Lakehouse. A story-driven, SEO-friendly guide covering file management, Z-ORDER, caching, Photon, SQL tuning, and architecture best practices.",keywords:["Databricks performance tuning","Lakehouse performance best practices","Delta Lake optimization","Databricks tuning guide","data engineering performance"]},o="Improving Lakehouse Performance \u2014 Dos & Don\u2019ts",a={},d=[{value:"\u2728 Story Time \u2014 \u201cWhy Is the Lakehouse Getting Slower?\u201d",id:"-story-time--why-is-the-lakehouse-getting-slower",level:2},{value:"\ud83d\udfe9 DO: Compact Files &amp; Run OPTIMIZE Regularly",id:"-do-compact-files--run-optimize-regularly",level:2},{value:"Recommended:",id:"recommended",level:3},{value:"Use Cases:",id:"use-cases",level:3},{value:"\ud83d\udfe5 DON&#39;T: Let Tiny Files Accumulate",id:"-dont-let-tiny-files-accumulate",level:2},{value:"\ud83d\udfe9 DO: Use Z-ORDER for Filter Columns",id:"-do-use-z-order-for-filter-columns",level:2},{value:"Best for queries filtering by:",id:"best-for-queries-filtering-by",level:3},{value:"Example:",id:"example",level:3},{value:"\ud83d\udfe5 DON&#39;T: Z-ORDER Too Many Columns",id:"-dont-z-order-too-many-columns",level:2},{value:"\ud83d\udfe9 DO: Use Photon for SQL Queries",id:"-do-use-photon-for-sql-queries",level:2},{value:"Perfect for:",id:"perfect-for",level:3},{value:"\ud83d\udfe5 DON&#39;T: Expect Photon to Speed Up Everything",id:"-dont-expect-photon-to-speed-up-everything",level:2},{value:"\ud83d\udfe9 DO: Partition For Write Volume, Not Read Volume",id:"-do-partition-for-write-volume-not-read-volume",level:2},{value:"\ud83d\udfe5 DON&#39;T: Over-Partition",id:"-dont-over-partition",level:2},{value:"\ud83d\udfe9 DO: Cache Hot Tables",id:"-do-cache-hot-tables",level:2},{value:"\ud83d\udfe5 DON&#39;T: Cache Large, Rarely Used Tables",id:"-dont-cache-large-rarely-used-tables",level:2},{value:"\ud83d\udfe9 DO: Tune SQL Endpoints Properly",id:"-do-tune-sql-endpoints-properly",level:2},{value:"\ud83d\udfe5 DON&#39;T: Run Dashboards on Job Clusters",id:"-dont-run-dashboards-on-job-clusters",level:2},{value:"\ud83d\udfe9 DO: Reduce Shuffle &amp; Skew",id:"-do-reduce-shuffle--skew",level:2},{value:"\ud83d\udfe9 DO: Monitor &amp; Profile Queries",id:"-do-monitor--profile-queries",level:2},{value:"\ud83d\udcd8 Summary",id:"-summary",level:2},{value:"\u2714 Storage optimization",id:"-storage-optimization",level:3},{value:"\u2714 Compute optimization",id:"-compute-optimization",level:3},{value:"\u2714 Query optimization",id:"-query-optimization",level:3},{value:"\u2714 Architecture alignment",id:"-architecture-alignment",level:3}];function c(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"improving-lakehouse-performance--dos--donts",children:"Improving Lakehouse Performance \u2014 Dos & Don\u2019ts"})}),"\n",(0,s.jsx)(n.h2,{id:"-story-time--why-is-the-lakehouse-getting-slower",children:"\u2728 Story Time \u2014 \u201cWhy Is the Lakehouse Getting Slower?\u201d"}),"\n",(0,s.jsx)(n.p,{children:"Ethan is the lead data engineer at a fast-scaling startup."}),"\n",(0,s.jsx)(n.p,{children:"What began as a simple Lakehouse with 10 tables has now grown to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"200+ tables"}),"\n",(0,s.jsx)(n.li,{children:"Multiple ETL pipelines"}),"\n",(0,s.jsx)(n.li,{children:"Streaming + batch mixed workloads"}),"\n",(0,s.jsx)(n.li,{children:"Dashboards hitting data every few minutes"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Suddenly:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Queries slow down"}),"\n",(0,s.jsx)(n.li,{children:"Jobs take longer"}),"\n",(0,s.jsx)(n.li,{children:"Costs spike"}),"\n",(0,s.jsxs)(n.li,{children:["The CTO asks:",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.strong,{children:"\u201cIs our Lakehouse breaking?\u201d"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Ethan takes a deep breath.",(0,s.jsx)(n.br,{}),"\n","The Lakehouse is fine \u2014 it just needs proper ",(0,s.jsx)(n.strong,{children:"performance tuning"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Let\u2019s learn the ",(0,s.jsx)(n.strong,{children:"right"})," and ",(0,s.jsx)(n.strong,{children:"wrong"})," ways to do that."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-compact-files--run-optimize-regularly",children:"\ud83d\udfe9 DO: Compact Files & Run OPTIMIZE Regularly"}),"\n",(0,s.jsx)(n.p,{children:"Small files = slow reads + high compute cost."}),"\n",(0,s.jsx)(n.h3,{id:"recommended",children:"Recommended:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"OPTIMIZE table_name;\r\nOPTIMIZE table_name ZORDER BY (important_column);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"use-cases",children:"Use Cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"High-ingestion tables"}),"\n",(0,s.jsx)(n.li,{children:"Streaming outputs"}),"\n",(0,s.jsx)(n.li,{children:"CDC pipelines"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," Faster scans, better data skipping, lower cost."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-let-tiny-files-accumulate",children:"\ud83d\udfe5 DON'T: Let Tiny Files Accumulate"}),"\n",(0,s.jsx)(n.p,{children:"If your table has:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Thousands of small files"}),"\n",(0,s.jsx)(n.li,{children:"10KB or 100KB files"}),"\n",(0,s.jsx)(n.li,{children:"Heavy streaming writes"}),"\n",(0,s.jsx)(n.li,{children:"Over-partitioning"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u2026 your performance will crash."}),"\n",(0,s.jsx)(n.p,{children:"Symptoms:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Slow queries"}),"\n",(0,s.jsx)(n.li,{children:"High I/O"}),"\n",(0,s.jsx)(n.li,{children:"Excessive metadata operations"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Prevent file explosion with Auto-Optimize:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"ALTER TABLE my_table\r\nSET TBLPROPERTIES (\r\n  'delta.autoOptimize.optimizeWrite' = 'true',\r\n  'delta.autoOptimize.autoCompact' = 'true'\r\n);\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-use-z-order-for-filter-columns",children:"\ud83d\udfe9 DO: Use Z-ORDER for Filter Columns"}),"\n",(0,s.jsx)(n.p,{children:"Z-ORDER physically clusters related values."}),"\n",(0,s.jsx)(n.h3,{id:"best-for-queries-filtering-by",children:"Best for queries filtering by:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"customer_id"}),"\n",(0,s.jsx)(n.li,{children:"event_date"}),"\n",(0,s.jsx)(n.li,{children:"device_id"}),"\n",(0,s.jsx)(n.li,{children:"sku or product_id"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example",children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"OPTIMIZE events ZORDER BY (device_id, event_timestamp);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," 5\xd7\u201320\xd7 faster filter-based queries."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-z-order-too-many-columns",children:"\ud83d\udfe5 DON'T: Z-ORDER Too Many Columns"}),"\n",(0,s.jsxs)(n.p,{children:["Z-ORDER works best with ",(0,s.jsx)(n.strong,{children:"1\u20133 columns"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Problems with too many columns:"}),"\n",(0,s.jsx)(n.p,{children:"\u2716 Slower OPTIMIZE\r\n\u2716 Too much data movement\r\n\u2716 No performance gain"}),"\n",(0,s.jsx)(n.p,{children:"Keep it simple \u2192 only Z-ORDER your primary filter keys."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-use-photon-for-sql-queries",children:"\ud83d\udfe9 DO: Use Photon for SQL Queries"}),"\n",(0,s.jsx)(n.p,{children:"Photon = Databricks\u2019 ultra-fast C++ execution engine."}),"\n",(0,s.jsx)(n.h3,{id:"perfect-for",children:"Perfect for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"BI dashboards"}),"\n",(0,s.jsx)(n.li,{children:"Large SQL aggregations"}),"\n",(0,s.jsx)(n.li,{children:"Ad-hoc analytics"}),"\n",(0,s.jsx)(n.li,{children:"Interactive data exploration"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Enable Photon in SQL Warehouses & All-purpose clusters."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-expect-photon-to-speed-up-everything",children:"\ud83d\udfe5 DON'T: Expect Photon to Speed Up Everything"}),"\n",(0,s.jsx)(n.p,{children:"Photon doesn\u2019t accelerate:"}),"\n",(0,s.jsx)(n.p,{children:"\u2716 Python UDFs\r\n\u2716 R or Scala-heavy workloads\r\n\u2716 ML pipelines\r\n\u2716 Non-SQL transformations"}),"\n",(0,s.jsx)(n.p,{children:"Use Photon only where it makes sense."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-partition-for-write-volume-not-read-volume",children:"\ud83d\udfe9 DO: Partition For Write Volume, Not Read Volume"}),"\n",(0,s.jsx)(n.p,{children:"Partitioning helps huge ingestion workloads."}),"\n",(0,s.jsx)(n.p,{children:"Examples:"}),"\n",(0,s.jsxs)(n.p,{children:["\u2714 ",(0,s.jsx)(n.code,{children:"partition by date"}),"\r\n\u2714 ",(0,s.jsx)(n.code,{children:"partition by region"})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-over-partition",children:"\ud83d\udfe5 DON'T: Over-Partition"}),"\n",(0,s.jsx)(n.p,{children:"Too many partitions \u2192 tiny files \u2192 slow queries."}),"\n",(0,s.jsx)(n.p,{children:"Bad examples:"}),"\n",(0,s.jsx)(n.p,{children:"\u2716 Partitioning by customer_id\r\n\u2716 Partitioning by 1000+ values"}),"\n",(0,s.jsx)(n.p,{children:"Rule:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"If a partition will contain < 256MB of data \u2192 don\u2019t partition by it."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-cache-hot-tables",children:"\ud83d\udfe9 DO: Cache Hot Tables"}),"\n",(0,s.jsx)(n.p,{children:"Cache tables used repeatedly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CACHE TABLE daily_sales;\n"})}),"\n",(0,s.jsx)(n.p,{children:"Great for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"BI dashboards"}),"\n",(0,s.jsx)(n.li,{children:"Repeated queries"}),"\n",(0,s.jsx)(n.li,{children:"Interactive explorations"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-cache-large-rarely-used-tables",children:"\ud83d\udfe5 DON'T: Cache Large, Rarely Used Tables"}),"\n",(0,s.jsxs)(n.p,{children:["Caching is ",(0,s.jsx)(n.strong,{children:"not storage"})," \u2014 it\u2019s memory."]}),"\n",(0,s.jsx)(n.p,{children:"Avoid caching:"}),"\n",(0,s.jsx)(n.p,{children:"\u2716 5 TB tables\r\n\u2716 Cold data rarely queried\r\n\u2716 Tables that update frequently"}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-tune-sql-endpoints-properly",children:"\ud83d\udfe9 DO: Tune SQL Endpoints Properly"}),"\n",(0,s.jsx)(n.p,{children:"For BI dashboards:"}),"\n",(0,s.jsxs)(n.p,{children:["\u2714 Use ",(0,s.jsx)(n.strong,{children:"Pro"})," or ",(0,s.jsx)(n.strong,{children:"Serverless SQL Warehouses"}),"\r\n\u2714 Enable autoscaling\r\n\u2714 Tune concurrency\r\n\u2714 Allow the warehouse to scale up during peak hours"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-dont-run-dashboards-on-job-clusters",children:"\ud83d\udfe5 DON'T: Run Dashboards on Job Clusters"}),"\n",(0,s.jsx)(n.p,{children:"Job clusters are:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Temporary"}),"\n",(0,s.jsx)(n.li,{children:"Not cached"}),"\n",(0,s.jsx)(n.li,{children:"Not optimized for BI"}),"\n",(0,s.jsx)(n.li,{children:"Slow for dashboards"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Use SQL Warehouses instead."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-reduce-shuffle--skew",children:"\ud83d\udfe9 DO: Reduce Shuffle & Skew"}),"\n",(0,s.jsx)(n.p,{children:"Data skew leads to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Long-running tasks"}),"\n",(0,s.jsx)(n.li,{children:"Failed jobs"}),"\n",(0,s.jsx)(n.li,{children:"High compute cost"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Fix skew by:"}),"\n",(0,s.jsxs)(n.p,{children:["\u2714 Salting keys\r\n\u2714 Using ",(0,s.jsx)(n.code,{children:"REPARTITION"}),"\r\n\u2714 Broadcasting small tables\r\n\u2714 Reducing unnecessary joins"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT /*+ BROADCAST(dim_table) */\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-do-monitor--profile-queries",children:"\ud83d\udfe9 DO: Monitor & Profile Queries"}),"\n",(0,s.jsx)(n.p,{children:"Databricks gives you powerful tools:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Query Profile"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Query History"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Spark UI"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"SQL Query Insights"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Track:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Shuffle volume"}),"\n",(0,s.jsx)(n.li,{children:"Scan volume"}),"\n",(0,s.jsx)(n.li,{children:"Stage execution time"}),"\n",(0,s.jsx)(n.li,{children:"Skewed partitions"}),"\n",(0,s.jsx)(n.li,{children:"Photon usage"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-summary",children:"\ud83d\udcd8 Summary"}),"\n",(0,s.jsx)(n.p,{children:"Improving Lakehouse performance is a balance of:"}),"\n",(0,s.jsx)(n.h3,{id:"-storage-optimization",children:"\u2714 Storage optimization"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Compact files"}),"\n",(0,s.jsx)(n.li,{children:"Z-ORDER"}),"\n",(0,s.jsx)(n.li,{children:"OPTIMIZE"}),"\n",(0,s.jsx)(n.li,{children:"Correct partitioning"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-compute-optimization",children:"\u2714 Compute optimization"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Photon"}),"\n",(0,s.jsx)(n.li,{children:"Correct cluster sizing"}),"\n",(0,s.jsx)(n.li,{children:"Autoscaling"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-query-optimization",children:"\u2714 Query optimization"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Avoid SELECT *"}),"\n",(0,s.jsx)(n.li,{children:"Filter early"}),"\n",(0,s.jsx)(n.li,{children:"Broadcast joins"}),"\n",(0,s.jsx)(n.li,{children:"Tune SQL endpoints"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-architecture-alignment",children:"\u2714 Architecture alignment"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use SQL Warehouses for BI"}),"\n",(0,s.jsx)(n.li,{children:"Avoid over-caching"}),"\n",(0,s.jsx)(n.li,{children:"Prevent small file problems"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"A well-tuned Lakehouse is fast, cost-efficient, and extremely scalable."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"-next-topic",children:"\ud83d\udc49 Next Topic"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Unity Catalog \u2014 Central Governance Explained"})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>o});var r=i(6540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);