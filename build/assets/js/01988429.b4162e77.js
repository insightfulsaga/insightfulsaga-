"use strict";(self.webpackChunkdatacraft_school=self.webpackChunkdatacraft_school||[]).push([[7662],{2211:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>i});const s=JSON.parse('{"id":"databricks-end-to-end-demo","title":"Hands-On Demo- Ingest \u2192 Transform \u2192 Insight with Databricks","description":"We\u2019ll simulate a Retail Orders mini-project (works as a Databricks notebook)","source":"@site/docs-databricks/databricks-end-to-end-demo.md","sourceDirName":".","slug":"/databricks-end-to-end-demo","permalink":"/databricks/databricks-end-to-end-demo","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"databricks-end-to-end-demo","title":"Hands-On Demo- Ingest \u2192 Transform \u2192 Insight with Databricks","sidebar_label":"Hands-On- Ingest to Insight"}}');var t=n(4848),a=n(8453);const o={id:"databricks-end-to-end-demo",title:"Hands-On Demo- Ingest \u2192 Transform \u2192 Insight with Databricks",sidebar_label:"Hands-On- Ingest to Insight"},d="Hands-On Demo Flow (End-to-End)",l={},i=[{value:"0. Setup (paths &amp; imports)",id:"0-setup-paths--imports",level:2},{value:"1. Ingestion \u2192 Bronze (raw, as-is)",id:"1-ingestion--bronze-raw-as-is",level:2},{value:"2. Cleaning/Validation \u2192 Silver (structured, deduped, typed)",id:"2-cleaningvalidation--silver-structured-deduped-typed",level:2},{value:"3. Business Models \u2192 Gold (aggregates for BI/AI)",id:"3-business-models--gold-aggregates-for-biai",level:2},{value:"4. SQL Insights (Databricks SQL / Notebook %sql magic)",id:"4-sql-insights-databricks-sql--notebook-sql-magic",level:2},{value:"5. Orchestrate &amp; Operationalize (Jobs/Workflows)",id:"5-orchestrate--operationalize-jobsworkflows",level:2},{value:"6. Performance &amp; Governance touches",id:"6-performance--governance-touches",level:2}];function c(e){const r={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"hands-on-demo-flow-end-to-end",children:"Hands-On Demo Flow (End-to-End)"})}),"\n",(0,t.jsx)(r.p,{children:"We\u2019ll simulate a Retail Orders mini-project (works as a Databricks notebook)"}),"\n",(0,t.jsx)(r.h2,{id:"0-setup-paths--imports",children:"0. Setup (paths & imports)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Imports: PySpark core\r\nfrom pyspark.sql import functions as F            # F: column functions (select, filter, agg, etc.)\r\nfrom pyspark.sql import types as T                # T: data types (StringType, IntegerType...)\r\nfrom pyspark.sql.window import Window             # Window: dedup & ranking operations\r\n\r\n# Initialize Spark session (skip in Databricks)\r\nspark = SparkSession.builder.appName("RetailETL").getOrCreate()\r\n\r\n# Set base paths (DBFS or external mount)\r\nbase = "/tmp/demo_retail"                         # Change to your mount, e.g. /mnt/bronze/...\r\nbronze_path = f"{base}/bronze/orders"\r\nsilver_path = f"{base}/silver/orders"\r\ngold_path   = f"{base}/gold/metrics"\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No output (setup cell).\n"})}),"\n",(0,t.jsx)(r.h2,{id:"1-ingestion--bronze-raw-as-is",children:"1. Ingestion \u2192 Bronze (raw, as-is)"}),"\n",(0,t.jsx)(r.p,{children:"Create a tiny synthetic dataset so you can run this anywhere."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"i. Define schema explicitly (good practice for CSV/JSON ingestion)"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'orders_schema = T.StructType([\r\n    T.StructField("order_id", T.StringType(),  True),   # order identifier (may arrive duplicated)\r\n    T.StructField("order_ts", T.StringType(),  True),   # timestamp as string in raw (to be typed later)\r\n    T.StructField("customer_id", T.StringType(), True), # customer foreign key\r\n    T.StructField("sku", T.StringType(),       True),   # product id\r\n    T.StructField("qty", T.IntegerType(),      True),   # quantity\r\n    T.StructField("unit_price", T.DoubleType(),True),   # price per unit\r\n    T.StructField("status", T.StringType(),    True),   # \'Created\',\'Completed\',\'Cancelled\', ...\r\n    T.StructField("channel", T.StringType(),   True),   # \'web\',\'store\'\r\n])\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No output (schema definition).\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"ii. Create raw rows (simulate ingestion)"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'raw_rows = [\r\n    ("o-1001","2025-08-31 09:12:00","c-9","sku-1",1,19.99,"Completed","web"),\r\n    ("o-1002","2025-08-31 09:15:00","c-2","sku-2",2,12.50,"Completed","store"),\r\n    ("o-1002","2025-08-31 09:15:00","c-2","sku-2",2,12.50,"Completed","store"),  # duplicate\r\n    ("o-1003","2025-08-31 09:20:00","c-5","sku-7",1,49.00,"Cancelled","web"),\r\n    ("o-1004","2025-08-31 09:35:00","c-9","sku-1",3,19.99,"Completed","web"),\r\n]\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No output (just a list).\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"iii. Create Bronze DataFrame (raw)"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:"bronze_df = spark.createDataFrame(raw_rows, schema=orders_schema)\r\nbronze_df.show()\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"+--------+-------------------+-----------+------+---+----------+---------+-------+\r\n|order_id|order_ts           |customer_id|sku   |qty|unit_price|status   |channel|\r\n+--------+-------------------+-----------+------+---+----------+---------+-------+\r\n|o-1001  |2025-08-31 09:12:00|c-9        |sku-1 |1  |19.99     |Completed|web    |\r\n|o-1002  |2025-08-31 09:15:00|c-2        |sku-2 |2  |12.5      |Completed|store  |\r\n|o-1002  |2025-08-31 09:15:00|c-2        |sku-2 |2  |12.5      |Completed|store  |\r\n|o-1003  |2025-08-31 09:20:00|c-5        |sku-7 |1  |49.0      |Cancelled|web    |\r\n|o-1004  |2025-08-31 09:35:00|c-9        |sku-1 |3  |19.99     |Completed|web    |\r\n+--------+-------------------+-----------+------+---+----------+---------+-------+\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"iv. Write as Delta (raw/immutable style)"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'bronze_df.write.format("delta").mode("overwrite").save(bronze_path)  # Use Delta Lake for ACID + versioning.mode("overwrite")               # Fresh demo; use \'append\' in real pipelines\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No direct output, but the Delta table is saved.\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"What you did:"})," You ingested raw orders as-is into a Delta table (Bronze). This mirrors real ingestion from CSV/JSON/Kafka."]}),"\n",(0,t.jsx)(r.h2,{id:"2-cleaningvalidation--silver-structured-deduped-typed",children:"2. Cleaning/Validation \u2192 Silver (structured, deduped, typed)"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Read Bronze"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'b = spark.read.format("delta").load(bronze_path)\n'})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Type conversions + computed columns\r\ns = (b\r\n     .withColumn("order_ts", F.to_timestamp("order_ts", "yyyy-MM-dd HH:mm:ss"))\r\n     .withColumn("line_amount", F.col("qty") * F.col("unit_price"))\r\n     .withColumn("status_std", F.initcap("status"))\r\n    )\r\n\r\ns.select("order_id", "order_ts", "qty", "unit_price", "line_amount", "status", "status_std").show()\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"+--------+-------------------+---+----------+-----------+---------+-----------+\r\n|order_id|order_ts           |qty|unit_price|line_amount|status   |status_std|\r\n+--------+-------------------+---+----------+-----------+---------+-----------+\r\n|o-1001  |2025-08-31 09:12:00|1  |19.99     |19.99      |Completed|Completed |\r\n|o-1002  |2025-08-31 09:15:00|2  |12.5      |25.0       |Completed|Completed |\r\n|o-1002  |2025-08-31 09:15:00|2  |12.5      |25.0       |Completed|Completed |\r\n|o-1003  |2025-08-31 09:20:00|1  |49.0      |49.0       |Cancelled|Cancelled |\r\n|o-1004  |2025-08-31 09:35:00|3  |19.99     |59.97      |Completed|Completed |\r\n+--------+-------------------+---+----------+-----------+---------+-----------+\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Deduplicate by business key (order_id); keep latest by order_ts"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'w = Window.partitionBy("order_id").orderBy(F.col("order_ts").desc())\r\n\r\ns_dedup = (s\r\n           .withColumn("rn", F.row_number().over(w))\r\n           .filter(F.col("rn") == 1)\r\n           .drop("rn"))\r\n\r\ns_dedup.select("order_id", "order_ts", "sku", "qty", "status_std").show()\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"+--------+-------------------+------+---+-----------+\r\n|order_id|order_ts           |sku   |qty|status_std|\r\n+--------+-------------------+------+---+-----------+\r\n|o-1001  |2025-08-31 09:12:00|sku-1 |1  |Completed |\r\n|o-1002  |2025-08-31 09:15:00|sku-2 |2  |Completed |\r\n|o-1003  |2025-08-31 09:20:00|sku-7 |1  |Cancelled |\r\n|o-1004  |2025-08-31 09:35:00|sku-1 |3  |Completed |\r\n+--------+-------------------+------+---+-----------+\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Keep only valid, completed orders"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'s_clean = (s_dedup\r\n           .filter(F.col("status_std") == "Completed")\r\n           .drop("status"))  # optional\r\n\r\ns_clean.select("order_id", "order_ts", "sku", "qty", "line_amount").show()\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"+--------+-------------------+------+---+-----------+\r\n|order_id|order_ts           |sku   |qty|line_amount|\r\n+--------+-------------------+------+---+-----------+\r\n|o-1001  |2025-08-31 09:12:00|sku-1 |1  |19.99      |\r\n|o-1002  |2025-08-31 09:15:00|sku-2 |2  |25.0       |\r\n|o-1004  |2025-08-31 09:35:00|sku-1 |3  |59.97      |\r\n+--------+-------------------+------+---+-----------+\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Persist to Silver"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'(s_clean.write.format("delta").mode("overwrite").save(silver_path))\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No output, Delta table saved.\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Key ideas:"})," Cast types, add business columns, deduplicate, and filter to valid business states. That\u2019s Silver."]}),"\n",(0,t.jsx)(r.h2,{id:"3-business-models--gold-aggregates-for-biai",children:"3. Business Models \u2192 Gold (aggregates for BI/AI)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Read Silver\r\ns = spark.read.format("delta").load(silver_path)\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"Same as final Silver data above \u2014 3 clean, deduplicated, completed rows.\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Example 1: Daily revenue per channel\r\ngold_daily = (s\r\n    .withColumn("order_date", F.to_date("order_ts"))\r\n    .groupBy("order_date", "channel")\r\n    .agg(\r\n        F.sum("line_amount").alias("revenue"),\r\n        F.countDistinct("order_id").alias("orders"),\r\n        F.sum("qty").alias("units")\r\n    )\r\n)\r\n\r\ngold_daily.orderBy("order_date", "channel").show()\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"+-----------+-------+-------+------+-----+\r\n|order_date |channel|revenue|orders|units|\r\n+-----------+-------+-------+------+-----+\r\n|2025-08-31 |store  |25.0   |1     |2    |\r\n|2025-08-31 |web    |79.96  |2     |4    |\r\n+-----------+-------+-------+------+-----+\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Example 2: Top SKUs by revenue\r\n\r\ngold_sku = (s\r\n    .groupBy("sku")\r\n    .agg(\r\n        F.sum("line_amount").alias("revenue"),\r\n        F.sum("qty").alias("units"),\r\n        F.countDistinct("order_id").alias("orders")\r\n    )\r\n    .orderBy(F.col("revenue").desc())\r\n)\r\n\r\ngold_sku.show()\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-test",children:"+------+-------+-----+------+\r\n|sku   |revenue|units|orders|\r\n+------+-------+-----+------+\r\n|sku-1 |79.96  |4    |2     |\r\n|sku-2 |25.0   |2    |1     |\r\n+------+-------+-----+------+\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'# Persist Gold (you might create multiple Golds)\r\n\r\n(gold_daily.write.format("delta").mode("overwrite").save(f"{gold_path}/daily_by_channel"))\r\n\r\n(gold_sku.write.format("delta").mode("overwrite").save(f"{gold_path}/top_skus"))\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Result"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-text",children:"No output; two Gold Delta tables saved.\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Gold"})," = answers. These are the exact tables BI tools or ML features consume."]}),"\n",(0,t.jsx)(r.h2,{id:"4-sql-insights-databricks-sql--notebook-sql-magic",children:"4. SQL Insights (Databricks SQL / Notebook %sql magic)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"-- Create SQL views over Gold for analysts (optional)\r\nCREATE OR REPLACE TEMP VIEW gold_daily AS\r\nSELECT * FROM delta.'/tmp/demo_retail/gold/metrics/daily_by_channel';\r\n\r\nCREATE OR REPLACE TEMP VIEW gold_top_skus AS\r\nSELECT * FROM delta.'/tmp/demo_retail/gold/metrics/top_skus';\r\n\r\n-- Example insights\r\nSELECT order_date, channel, revenue, orders, units\r\nFROM gold_daily\r\nORDER BY order_date, channel;\r\n\r\nSELECT sku, revenue, units, orders\r\nFROM gold_top_skus\r\nLIMIT 10;\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Tip:"})," In Unity Catalog environments, prefer catalog.schema.table names rather than paths, e.g.,\r\nCREATE TABLE retail.gold.daily_by_channel USING DELTA LOCATION '...'."]}),"\n",(0,t.jsx)(r.h2,{id:"5-orchestrate--operationalize-jobsworkflows",children:"5. Orchestrate & Operationalize (Jobs/Workflows)"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Notebook Tasks:"})}),"\n",(0,t.jsx)(r.p,{children:"Task A (Bronze load) \u2192 Task B (Silver clean) \u2192 Task C (Gold aggregates)."}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Schedule:"})," Hourly / Daily."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Retries & Alerts:"})," Set retry policy, email/Slack on failure."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Parameters:"})," Pass ingest_date, source_path to notebooks for reusability."]}),"\n",(0,t.jsx)(r.h2,{id:"6-performance--governance-touches",children:"6. Performance & Governance touches"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Performance:"})," OPTIMIZE ... ZORDER BY (order_date, sku) on big tables; cache hot Silver tables."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Cost:"})," Use job clusters + auto-termination."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Governance:"})," Put tables under Unity Catalog; grant SELECT to analyst groups; track lineage."]}),"\n",(0,t.jsx)(r.h1,{id:"bonus-equivalent-sql-pattern-quick-view",children:"Bonus: Equivalent SQL Pattern (quick view)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"-- Bronze \u2192 Silver in pure SQL (Delta tables)\r\nCREATE OR REPLACE TABLE silver_orders AS\r\nSELECT\r\n  order_id,\r\n  to_timestamp(order_ts, 'yyyy-MM-dd HH:mm:ss') AS order_ts,\r\n  customer_id,\r\n  sku,\r\n  qty,\r\n  unit_price,\r\n  initcap(status) AS status_std,\r\n  qty * unit_price AS line_amount\r\nFROM delta.'/tmp/demo_retail/bronze/orders';\r\n\r\n-- Dedup & filter\r\nCREATE OR REPLACE TABLE silver_orders_curated AS\r\nWITH ranked AS (\r\n  SELECT *,\r\n         row_number() OVER (PARTITION BY order_id ORDER BY order_ts DESC) AS rn\r\n  FROM silver_orders\r\n)\r\nSELECT * FROM ranked WHERE rn = 1 AND status_std = 'Completed';\r\n\r\n-- Gold aggregates\r\nCREATE OR REPLACE TABLE gold_daily_by_channel AS\r\nSELECT\r\n  date(order_ts) AS order_date,\r\n  channel,\r\n  sum(line_amount) AS revenue,\r\n  count(DISTINCT order_id) AS orders,\r\n  sum(qty) AS units\r\nFROM silver_orders_curated\r\nGROUP BY date(order_ts), channel;\n"})})]})}function u(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>d});var s=n(6540);const t={},a=s.createContext(t);function o(e){const r=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(a.Provider,{value:r},e.children)}}}]);